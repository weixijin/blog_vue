import{n as l,b as S}from"./index.25833e42.js";import{g as C,p as x,a as L,i as M}from"./data.d27333a2.js";import{c as R}from"./chatItem.cc13e145.js";var T=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"left-user-info bg-555 p-t-20 p-l-20 p-r-20"},[e("div",{staticClass:"w-80 h-80 b-r-50 o-h"},[e("e-image",{staticClass:"w-80 h-80 b-r-50",attrs:{src:t.parseResourceUrl(t.userdata.header_img),lazy:!1,title:t.userdata.username}})],1)])},k=[];const H={data(){return{}},computed:{...Vuex.mapState(["userdata"])},methods:{}},g={};var N=l(H,T,k,!1,j,null,null,null);function j(t){for(let s in g)this[s]=g[s]}var B=function(){return N.exports}(),P=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"demo"},[t._v(" centerList ")])},A=[];const F={props:{chatRoomList:{type:Object,default:()=>[]}},data(){return{}},methods:{}},p={};var O=l(F,P,A,!1,E,null,null,null);function E(t){for(let s in p)this[s]=p[s]}var U=function(){return O.exports}(),z=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"flex-1 flex-column-wrap im-right-chat"},[e("div",{staticClass:"flex-justify-between flex-wrap flex-center-wrap p-l-20 p-r-20 b-b-1",style:{height:t.headerHeight+"px"}},[e("div",{staticClass:"f-550"},[t._v(" "+t._s(t.im_name)+" "),t.onLine?e("span",[t._v(" ("+t._s(t.onLine)+") ")]):t._e()]),e("div",{staticClass:"flex-center-wrap"},[e("div",{staticClass:"w-40 h-40 flex-center",on:{click:function(i){i.stopPropagation(),t.isShowRoomInfo=!t.isShowRoomInfo}}},[e("i",{staticClass:"el-icon-s-tools f-24"})])])]),e("div",{class:["room-container p-l-20 p-r-20 b-b-1 p-t-10 p-b-10 pr",t.pageClass,t.isLoading?"op-0":""],style:{height:t.chatHeight-t.headerHeight-t.footerHeight+"px"},on:{scroll:t.scrollEvent}},[t.isShowTopNoMore?e("div",{staticClass:"f-12 c-primary flex-center"},[t._v("\u6CA1\u6709\u66F4\u591A\u4E86~")]):t._e(),t.chatInfo.chatList.length?t._l(t.chatInfo.chatList,function(i,a){return e("chatItem",{key:i._id,ref:"chatItemRef",refInFor:!0,class:[a!==0?"m-t-20":""],attrs:{row:i,roomMembers:t.chatInfo.roomInfo.roomMembers,roomMemberInfo:t.roomMemberInfo},on:{closeAllPlay:t.closeAllPlay}})}):e("div",[t._v("\u6682\u65E0")])],2),e("div",{staticClass:"im-send-continer p-l-20 flex-center-wrap p-r-20 pr",style:{height:t.footerHeight+"px"}},[e("div",{directives:[{name:"show",rawName:"v-show",value:t.isShowNewSysTip,expression:"isShowNewSysTip"}],staticClass:"tip-new p-a dp-i-b p-10 bg-cc b-r-4 f-14 c-fff cu",on:{click:function(i){return t.scrollToBottom(!0)}}},[t._v(" \u6709\u65B0\u6D88\u606F ")]),e("kl-emoji",{ref:"pushCommentRef",attrs:{type:"2"},on:{postComment:t.postComment}})],1),e("div",{directives:[{name:"clickoutside",rawName:"v-clickoutside",value:t.vClickoutside,expression:"vClickoutside"}],class:["right-room-info p-20",t.isShowRoomInfo?"right-room-info-show":""],style:t.getRightRoomStyle},[e("el-input",{attrs:{size:"small",placeholder:"\u6309\u6635\u79F0\u641C\u7D22"},model:{value:t.searchKey,callback:function(i){t.searchKey=i},expression:"searchKey"}}),e("div",{staticClass:"searchImgs m-t-10 flex-wrap flex-justify-between flex-multi-row"},[t._l(t.filterRoomMembers,function(i){var a,r,o;return e("div",{key:i._id,staticClass:"w-60 m-b-10"},[e("div",{staticClass:"w-60 h-60 o-h"},[e("e-image",{class:["w-60 h-60",(i==null?void 0:i.status)==1?"":"grayscale-img"],attrs:{src:t.parseResourceUrl(i==null||(a=i.author_id)===null||a===void 0?void 0:a.header_img),title:i==null||(r=i.author_id)===null||r===void 0?void 0:r.username,lazy:!1}})],1),e("div",{staticClass:"ell-1 f-14 m-t-10"},[t._v(" "+t._s(i==null||(o=i.author_id)===null||o===void 0?void 0:o.username)+" ")])])}),t._l(6,function(i){return e("div",{key:i,staticClass:"w-60"})})],2),e("div",{staticClass:"f-14 m-t-10"},[e("div",{staticClass:"f-14"},[t._v("\u7FA4\u804A\u540D\u79F0")]),e("div",{staticClass:"c-aaa m-t-4"},[t._v(" "+t._s(t.im_name)+" ")]),e("div",{staticClass:"m-t-10"},[t._v("\u7FA4\u516C\u544A")]),e("div",{staticClass:"c-aaa m-t-4"},[t._v("\u5728\u7EBF\u804A\u5929~~")]),t._m(0),e("div",{staticClass:"flex-justify-between flex-center-wrap h-40"},[e("span",[t._v(" \u663E\u793A\u6210\u5458\u6635\u79F0 ")]),e("el-switch",{attrs:{"active-value":1,"inactive-value":2,"active-color":"#13ce66","inactive-color":"#ff4949"},on:{change:t.post_im_room_member},model:{value:t.roomMemberInfo.is_show_username,callback:function(i){t.$set(t.roomMemberInfo,"is_show_username",i)},expression:"roomMemberInfo.is_show_username"}})],1),e("div",{staticClass:"flex-justify-between flex-center-wrap h-40"},[e("span",[t._v(" \u56FA\u5B9A\u81EA\u5DF1\u6D88\u606F\u5230\u53F3\u4FA7 ")]),e("el-switch",{attrs:{"active-value":1,"inactive-value":2,"active-color":"#13ce66","inactive-color":"#ff4949"},on:{change:t.post_im_room_member},model:{value:t.roomMemberInfo.is_sys_right,callback:function(i){t.$set(t.roomMemberInfo,"is_sys_right",i)},expression:"roomMemberInfo.is_sys_right"}})],1),e("div",{staticClass:"f-16 c-danger flex-center h-40 cu m-t-20",on:{click:t.remove}},[t._v("\u9000\u51FA\u7FA4\u804A")])])],1)])},D=[function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"flex-justify-between flex-center-wrap h-40"},[e("span",[t._v(" \u804A\u5929\u8BB0\u5F55 ")]),e("i",{staticClass:"el-icon-arrow-right"})])}];const K={components:{chatItem:R},props:{headerHeight:{type:Number,default:50},footerHeight:{type:Number,default:200},isLoading:{type:Boolean,default:!0},socket:{type:Object,default:()=>({})},chatInfo:{type:Object,default:()=>({roomInfo:{roomMembers:[]},chatList:[]})},total:{type:Number,default:0},imName:{type:String,default:""}},data(){return{value:"",searchKey:"",isShowRoomInfo:!1,pageClass:this.createId(),isBottom:!0,roomMemberInfo:{is_show_username:1,is_sys_right:1,room_username:""},isShowNewSysTip:!1,chatWidth:400,chatHeight:800}},computed:{...Vuex.mapState(["userdata"]),im_name(){return this.imName||this.chatInfo.roomInfo.im_name||"\u9ED8\u8BA4\u804A\u5929\u5BA4"},onLine(){let t=0;return this.chatInfo.roomInfo.roomMembers.forEach(s=>{s.status==1&&t++}),t},filterRoomMembers(){return this.sortRoomMembers.filter(t=>{var s,e;return(e=(s=t==null?void 0:t.author_id)==null?void 0:s.username)==null?void 0:e.includes(this.searchKey)})},sortRoomMembers(){return this.chatInfo.roomInfo.roomMembers.sort((t,s)=>t.status-s.status)},isShowTopNoMore(){return!this.isLoading&&this.chatInfo.chatList.length>=this.total},getRightRoomStyle(){return{height:this.chatHeight-this.headerHeight+"px"}}},watch:{isShowRoomInfo(t){},isShowNewSysTip(t){this.$emit("isShowNewSysTipFun",t)}},mounted(){this.get_im_room_member(),this.init()},methods:{closeAllPlay(){let{chatItemRef:t}=this.$refs;if(t&&t.length)for(let s=0;s<t.length;s++)t[s].isShowAudio=!1,t[s].isPlaying=!1},async init(){await this.$nextTick(),this.chatHeight=document.documentElement.clientHeight},narrowFun(){this.$emit("narrowFun")},get_im_room_member(t=""){let s=this.chatInfo.roomInfo.roomMembers.find(e=>e.author_id._id==this.userdata._id);s&&C({_id:s._id}).then(e=>{if(e.data&&e.data.data){let{is_sys_right:i,is_show_username:a}=e.data.data;Object.assign(this.roomMemberInfo,e.data.data,{is_show_username:+a,is_sys_right:+i})}}).catch(()=>{}).finally(()=>{t&&t()})},post_im_room_member(){x(this.roomMemberInfo).then(()=>{this.$message.success("\u4FEE\u6539\u6210\u529F")}).catch(()=>{this.get_im_room_member()})},remove(){this.$confirm("\u786E\u5B9A\u9000\u51FA\u8BE5\u7FA4\u804A\u5417\uFF1F").then(()=>{this.$emit("live_room")}).catch(()=>{})},vClickoutside(){this.isShowRoomInfo=!1},async reloadScrollPostion(){let t=document.querySelector(`.${this.pageClass}`);if(t){let s=t.scrollHeight;await this.$nextTick(),this.isIOS()&&($(t).css({display:"none"}),await this.sleep(1),$(t).css({display:"block"}),s=s+10);let i=document.querySelector(`.${this.pageClass}`).scrollHeight-s;t.scrollTop=i}},scrollEvent(t){let s=$(`.${this.pageClass}`);if(s){const e=s.scrollTop()||0,i=s.innerHeight()||0,a=s[0].scrollHeight||0;if(this.isBottom=e+i>=a-50,e<=50&&this.$emit("loadPrev"),!this.isShowNewSysTip)return;this.isBottom&&(this.isShowNewSysTip=!1)}},async scrollToBottom(t){if(!this.isBottom&&!t)return;await this.$nextTick();let s=$(`.${this.pageClass}`);s&&s.scrollTop(s[0].scrollHeight),this.$emit("postComment",!1)},postComment(t){this.$emit("postComment",!0),this.socket.emit("send_msg",{room_id:this.chatInfo.roomInfo._id,author_id:this.userdata._id,...t})}}},v={};var V=l(K,z,D,!1,q,"46c1a00f",null,null);function q(t){for(let s in v)this[s]=v[s]}var G=function(){return V.exports}(),J=function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("div",{staticClass:"flex-wrap"},[t.isShowLeft?e("leftUserInfo"):t._e(),t.isShowCenter?e("centerList",{attrs:{chatRoomList:t.chatInfo.chatList}}):t._e(),t.isShowRight?e("rightChat",{directives:[{name:"loading",rawName:"v-loading",value:t.isLoading,expression:"isLoading"}],ref:"rightChatRef",attrs:{isLoading:t.isLoading,socket:t.socket,chatInfo:t.chatInfo,total:t.pages.total,footerHeight:t.footerHeight,imName:t.imName},on:{loadPrev:t.loadPrev,postComment:t.postComment,live_room:t.live_room,setHeartBeatInit:t.setHeartBeat,isShowNewSysTipFun:t.isShowNewSysTipFun}}):t._e()],1)},W=[];const Q=[{js:"http://139.9.210.43:5000/netdist/socketio-1728970542295~1~.js"}],X={components:{leftUserInfo:B,centerList:U,rightChat:G},props:{isShowLeft:{type:Boolean,default:!0},isShowCenter:{type:Boolean,default:!1},isShowRight:{type:Boolean,default:!0},imOutPath:{type:String,default:""},isShowIm:{type:Boolean,default:!0},gobang_id:{type:String,default:""},game_im_id:{type:String,default:""},imName:{type:String,default:""}},data(){return{heartTime:5*1e3,timer:null,isUserActive:!1,isLoadMore:!1,isLoading:!0,socket:{},chatInfo:{roomInfo:{roomMembers:[],im_name:""},chatList:[]},pages:{page:1,limit:10,total:0}}},computed:{...Vuex.mapState(["userdata","userTags"]),...Vuex.mapGetters(["isAdmin"]),islogin(){return this.isLogin()},room_id(){var t,s;return((s=(t=this.chatInfo)==null?void 0:t.roomInfo)==null?void 0:s._id)||this.game_im_id||""},baseParams(){let{userdata:{_id:t},room_id:s,gobang_id:e}=this,i={user_id:t,room_id:s};return e&&(i.gobang_id=e),i},footerHeight(){return this.isPc(),200}},created(){this.getIndexDBJS(Q).finally(t=>{this.init()})},mounted(){this.isPc()||(this.isShowLeft=!1)},beforeDestroy(){this.socket.emit("live_room",this.baseParams),clearTimeout(this.timer),this.timer=null},methods:{async init(){let{game_im_id:t,gobang_id:s}=this;this.isLoading=!0;let e=!0;if(!t){let o=await L({type:1}).catch(()=>{});if(!o.data&&!o.data.data)return;const n=o.data.data;Object.assign(this.chatInfo.roomInfo,{_id:this.isArray(n)?n[0]._id:n._id})}let{room_id:i}=this;if(!i)return;this.socket=io.connect(S,{reconnection:!0,reconnectionAttempts:5,reconnectionDelay:1e3,reconnectionDelayMax:5e3,randomizationFactor:.5,timeout:1e4});const a={room_id:i,user_id:this.userdata._id};s&&(a.gobang_id=s),this.socket.emit("join_room",a),this.socket.on("err",o=>{if(this.setHeartBeat(),o.code==400){this.$message.error(o.msg||"--\u672A\u77E5\u9519\u8BEF--");return}this.$message.success(o.msg||"--\u672A\u77E5\u6D88\u606F--")}),this.socket.on("disconnect",()=>{console.log("\u8FDE\u63A5\u65AD\u5F00\uFF0C\u5C1D\u8BD5\u91CD\u8FDE...")}),this.socket.on("room_baseinfo",o=>{if(this.isDev()&&console.log("room_baseinfo",o.data),o.data){let{data:n,content:h,roomMembers:c,roomSysCount:y,gobangMembers:b,game_content:m,gb_info:f,is_del_gobang:_,clear_game:d,regret_result:u}=o.data;if(this.$emit("room_baseinfo",{gobangMembers:b,room_id:i}),m&&this.$emit("get_game_content",m),f&&this.$emit("get_gb_info",f),_&&this.$emit("del_gobang",_),d&&this.$emit("clear_game",d),Array.isArray(c)&&(Object.assign(this.chatInfo.roomInfo,n,{roomMembers:c}),e&&(e=!1,this.isLoading=!1)),this.getType(u)=="boolean"&&this.$emit("get_regret_result",u),this.pages.total=y,h){this.chatInfo.chatList.push(h),this.$emit("newMsg",{content:h});let{isBottom:I}=this.$refs.rightChatRef;(!I||!this.isShowIm)&&(this.$refs.rightChatRef.isShowNewSysTip=!0)}this.scrollToBottom(),this.setHeartBeat()}});let r=await this.$apis.get_chat_list({room_id:i}).catch(()=>({}));r.data&&this.isArrayLength(r.data.data)&&(this.chatInfo.chatList=r.data.data.reverse())},send_msg(t){this.socket.emit("send_msg",t)},isShowNewSysTipFun(t){this.$emit("isShowNewSysTipFun",t)},live_room(){this.socket.emit("live_room",this.baseParams),this.imOutPath&&this.goTo(this.imOutPath),this.$emit("live_room")},postComment(t=!1){this.isUserActive=t},loadPrev(){var r;let{room_id:t}=this;if(this.isLoadMore)return;let{page:s,limit:e,total:i}=this.pages;if(!this.isArray(this.chatInfo.chatList)||this.chatInfo.chatList.length>=i)return;let a=((r=this.chatInfo.chatList[0])==null?void 0:r._id)||"";!a||(this.isLoadMore=!0,this.$apis.get_chat_list({room_id:t,chat_id:a,limit:e}).then(o=>{if(o.data&&this.isArrayLength(o.data.data)){let{data:n}=o.data;this.chatInfo.chatList=[...n.reverse(),...this.chatInfo.chatList],this.$refs.rightChatRef.reloadScrollPostion()}}).catch(()=>{}).finally(async()=>{await this.sleep(),this.isLoadMore=!1,this.setHeartBeat()}))},scrollToBottom(){let{rightChatRef:t}=this.$refs;t&&t.scrollToBottom(this.isUserActive)},setHeartBeat(){let{room_id:t}=this;clearTimeout(this.timer),this.timer=setTimeout(()=>{M({room_id:t}).then(s=>{if(s&&this.isObject(s.data)&&this.isObject(s.data.data)){let{status:e}=s.data.data;e==2&&(console.log("\u60A8\u5DF2\u6389\u7EBF\uFF0C\u5F00\u59CB\u91CD\u65B0\u52A0\u5165"),this.socket.emit("join_room",{room_id:t,user_id:this.userdata._id})),this.setHeartBeat()}}).catch(()=>{})},this.heartTime)}}},w={};var Y=l(X,J,W,!1,Z,null,null,null);function Z(t){for(let s in w)this[s]=w[s]}var it=function(){return Y.exports}();export{it as default};
