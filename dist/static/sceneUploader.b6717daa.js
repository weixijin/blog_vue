import{n as d}from"./index.25833e42.js";var f=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{directives:[{name:"loading",rawName:"v-loading.fullscreen.lock",value:e.ossUploadLoading,expression:"ossUploadLoading",modifiers:{fullscreen:!0,lock:!0}}],staticClass:"uploadSch-formItem",attrs:{"element-loading-text":e.loadingText,"element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.4)"}},[e._t("head",null,{maxCount:e.maxCount}),i("el-upload",{staticClass:"scene-uploader",class:e.readonly&&"disabled",attrs:{action:"",multiple:"",accept:e.fileTypes,"on-preview":e.handlePreview,"on-remove":e.handleRemove,"on-exceed":e.handleExceed,"file-list":e.fileList,limit:e.maxCount,disabled:e.readonly||e.ossUploadLoading,"auto-upload":!1,"on-progress":e.handleProgress,"on-change":e.handleChange}},[i("el-button",{attrs:{slot:"trigger",size:"small",type:"primary",loading:e.ossUploadLoading},slot:"trigger"},[e._v(" \u4E0A\u4F20\u6587\u4EF6 ")]),i("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[e._v(" \u53EA\u80FD\u4E0A\u4F20"+e._s(e.supportSuffixList.join("/"))+"\u683C\u5F0F\u6587\u4EF6\uFF0C\u4E14\u5927\u5C0F\u4E0D\u8D85\u8FC7"+e._s(e.maxSize)+"M ")])],1),e.progress&&e.ossUploadLoading?i("el-progress",{attrs:{percentage:e.progressObj.percent||0,format:e.progressFormat}}):e._e()],2)},p=[];const c=["pdf","doc","docx","csv","xls","xlsx","jpg","jpeg","png","wav","aiff","mp3","wma","m4a","mp4","mov","ogg"],h=["pdf","doc","docx","csv","xls","xlsx"],n=["jpg","jpeg","png"],a=["wav","aiff","mp3","wma","m4a"],r=["mp4","mov","ogg"],g={name:"SceneUploader",props:{readonly:{type:Boolean,default:!1},maxSize:{type:Number,default:50},value:{type:Array,default:()=>[]},progress:{type:Boolean,default:()=>!1},maxCount:{type:Number,default:10},nameLengthLimit:{type:Number,default:50},isImageOnly:{type:Boolean,default:!1},isVideoOnly:{type:Boolean,default:!1},isVoiceVideoOnly:{type:Boolean,default:!1},viewAll:{type:Boolean,default:!1}},data(){return{timer:null,progressObj:{},previewImgVisible:!1,previewVideoVisible:!1,previewVoiceVisible:!1,viewList:[],viewIndex:0}},computed:{...Vuex.mapState("globalMod",["ossUploadLoading","ossUploadPercentage"]),supportSuffixList(){return this.isImageOnly?n:this.isVideoOnly?r:this.isVoiceVideoOnly?[...a,...r]:c},fileTypes(){return this.supportSuffixList.map(e=>"."+e).join(",")},fileList:{get(){return this.$props.value},set(e){this.$emit("update:value",e),this.$emit("change",e)}},loadingText(){let{percent:e,name:t=""}=this.ossUploadPercentage,i=t;return t.length>10&&(i=`${t.substr(0,10)}...`),`${i||"--"} \u6B63\u5728\u4E0A\u4F20\uFF0C\u8FDB\u5EA6\uFF1A${e||"--"}%\uFF0C\u8BF7\u7A0D\u540E\uFF0C\u8BF7\u52FF\u5173\u95ED\u6B64\u9875\u9762...`}},methods:{...Vuex.mapMutations({SET_OSS_UPLOAD_LOADING:"globalMod/SET_OSS_UPLOAD_LOADING"}),getSuffix(e){var t;return(((t=e==null?void 0:e.match(/\.([^.]*)$/))==null?void 0:t[1])||"").toLowerCase()},handleExceed(){this.$message.warning(`\u6700\u591A\u4E0A\u4F20 ${this.maxCount} \u4EFD\u9644\u4EF6\u8D44\u6599`)},handleProgress(e,t){this.progressObj=e},progressFormat(e=0){let{name:t=""}=this.progressObj,i=`${t}${t?" ":""}${e}%`;return t.length>20&&(i=`${t.substr(0,20)}... ${e}%`),i},handleChange(e,t){clearTimeout(this.timer),this.timer=setTimeout(()=>{!this.timer||this.httpRequest(t)},200)},hanldeCheckFileError(e,t){this.$message.warning(t);let i=e.filter(s=>s.status==="success");this.fileList=[...i]},checkFiles(e){const{maxSize:t}=this.$props;for(let i=0;i<e.length;i++){if(this.nameLengthLimit>0&&e[i].name.length>this.nameLengthLimit)return this.hanldeCheckFileError(e,"\u6587\u4EF6\u540D\u79F0\u8D85\u8FC750\u4E2A\u5B57\u7B26\uFF0C\u8BF7\u4FEE\u6539\u540E\u91CD\u65B0\u4E0A\u4F20"),!1;if(t){const{size:l}=e[i];if(l>t*1024*1024)return this.hanldeCheckFileError(e,`\u4E0D\u80FD\u4E0A\u4F20\u5927\u4E8E${t}M\u7684\u6587\u4EF6\uFF0C\u8BF7\u91CD\u65B0\u9009\u62E9\uFF01`),!1}const s=this.getSuffix(e[i].name);if(!this.supportSuffixList.includes(s))return this.hanldeCheckFileError(e,`\u5305\u542B\u4E0D\u652F\u6301\u4E0A\u4F20\u7684\u6587\u4EF6\uFF0C\u73B0\u53EA\u652F\u6301 ${this.supportSuffixList.join(",")} \u7B49\u683C\u5F0F!`),!1}return!0},ossUploadFn(){},async httpRequest(e){if(this.checkFiles(e))try{this.SET_OSS_UPLOAD_LOADING(!0);for await(let t of e){const{name:i,raw:s,status:o}=t;if(o==="ready"){const{url:l}=await ossUploadFn(s,this.$refs.uploadRef);this.fileList=this.fileList.concat({name:i,url:l}),this.$nextTick(()=>{this.$emit("getFileList",this.fileList)})}}}finally{this.SET_OSS_UPLOAD_LOADING(!1)}},handlePreview(e){const t=this.getSuffix(e.name);n.includes(t)?(this.viewAll?(this.viewList=this.fileList.filter(i=>{const s=this.getSuffix(i.name);return n.includes(s)}).map(i=>i.url),this.viewIndex=this.viewList.findIndex(i=>e.url===i)):this.viewList=[e.url],this.previewImgVisible=!0):r.includes(t)?(this.viewAll?(this.viewList=this.fileList.filter(i=>{const s=this.getSuffix(i.name);return r.includes(s)}),this.viewIndex=this.viewList.findIndex(i=>e.url===i.url)):this.viewList=[e],this.previewVideoVisible=!0):a.includes(t)?(this.viewAll?(this.viewList=this.fileList.filter(i=>{const s=this.getSuffix(i.name);return a.includes(s)}),this.viewIndex=this.viewList.findIndex(i=>e.url===i.url)):this.viewList=[e],this.previewVoiceVisible=!0):h.includes(t)?window.open(`${{}.VUE_APP_SERVER_ADDRESS_FILE_PREVIEW}/common/file/previewByUrl?src=${encodeURIComponent(e.url)}`):this.downFile(e.url,e.name),console.log(this.viewIndex)},handleRemove(e,t){this.fileList=t,this.$emit("getFileList",t)},downFile(e,t){let i=e.split(".").pop().toLocaleLowerCase();t=`${t||"\u9644\u4EF6"}.${i}`,this.getFileName&&(t=`${this.getFileName()}-${t}`);const s=new window.XMLHttpRequest;s.open("GET",e,!0),s.responseType="blob",s.onload=()=>{const o=window.URL.createObjectURL(s.response),l=document.createElement("a");l.href=o,l.download=t,l.click()},s.send()},closeImgViewer(){this.previewImgVisible=!1},closeVideoViewer(){this.previewVideoVisible=!1},closeVoiceViewer(){this.previewVoiceVisible=!1}}},u={};var m=d(g,f,p,!1,v,"d4ecd0f6",null,null);function v(e){for(let t in u)this[t]=u[t]}var w=function(){return m.exports}();export{w as default};
